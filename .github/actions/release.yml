name: "Semantic release"
description: "Runs the release"

runs:
  using: "composite"
  steps:
    - name: Install node
      uses: actions/setup-node@v4
      with:
        node-version: "18"

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-

    - name: Install dependencies
      run: npm ci

    - name: Bump version and generate changelog
      uses: mikepenz/release-changelog-builder-action@v4.1.1
      id: changelog
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -am "chore(release): ${VERSION}"

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ env.TOKEN_GITHUB }}
        branch: ${{ github.ref }}

    - name: Build Docker image
      run: docker build -t ${{env.DOCKERHUB_USERNAME}}/cexa:${{ steps.package.outputs.version }} .

    - name: Log in to DockerHub
      run: echo "${{ env.DOCKERHUB_PASSWORD }}" | docker login -u ${{ env.DOCKERHUB_USERNAME }} --password-stdin

    - name: Push Docker image
      run: docker push ${{env.DOCKERHUB_USERNAME}}/cexa:${{ steps.package.outputs.version }}

    - name: Create Docker secret
      run: echo "${{ env.CEXA_ENV_VALUE }}" | docker secret create CEXA_ENV_SECRETS -
